
# 実装計画 (ロードマップ)

LAN内アクセスを前提とした、アジャイル的な段階的開発計画です。

## Step 1: 開発環境の基盤構築 (Docker): DONE

- **やること**:
  - `Dockerfile`, `docker-compose.yml`, `requirements.txt` の作成
  - Djangoプロジェクトの作成と初期設定
- **ゴール**: `docker-compose up` コマンドで環境が立ち上がり、ブラウザでDjangoの初期画面が表示されること。

## Step 2: データモデルの設計と実装 (Backend): DONE

- **やること**:
  - `PokemonCard` モデルの定義（名称、属性、進化、枚数など）
  - データベースへのマイグレーション実行
- **ゴール**: データベース内にテーブルが作成され、データ保存の準備が整うこと。

## Step 3: 管理機能とCSV入出力の先行実装 (Admin): DONE

- **やること**:
  - Django管理画面 (Admin) の設定
  - `django-import-export` ライブラリの導入と設定
- **ゴール**: 管理画面からカード情報の登録・編集ができ、CSVでのエクスポート・インポートが動作すること。

## Step 4: 検索・一覧画面の実装 (Frontend - Read)

### 計画詳細化 (DaisyUI 導入)

DaisyUI の導入に伴い、Step4を以下の4フェーズに分けて段階的に実装します。

#### フェーズ1: フロントエンド開発環境の構築: DONE

- **目的**: DaisyUIを利用するためのCSSビルド環境 (Node.js) をDockerコンテナ内に構築し、Djangoプロジェクトと統合します。
- **やること**:
  - `Dockerfile`を更新し、Pythonに加えて`Node.js`と`npm`をインストールする。
  - `package.json`を作成し、`tailwindcss`, `daisyui`, `postcss`などの依存関係を定義する。
  - `tailwind.config.js`を作成し、DaisyUIプラグインの有効化と、監視対象のテンプレートファイルパスを設定する。
  - `docker-compose.yml`を更新し、コンテナ起動時にCSSビルドが実行されるように設定する。
  - Djangoの`settings.py`で、ビルドされたCSSが出力されるディレクトリを静的ファイルパスとして設定する。

#### フェーズ2: 基本レイアウトの作成: DONE

- **目的**: アプリケーション全体の骨格となるベーステンプレートをDaisyUIのコンポーネントで作成します。
- **やること**:
  - `templates/base.html`を作成し、DaisyUIのテーマ (`data-theme`) を設定する。
  - ヘッダー（ナビゲーションバー）、メインコンテンツ、フッターといった基本的なレイアウトをDaisyUIのクラスを用いて実装する。

#### フェーズ3: カード一覧画面の作成 (Read): DONE

- **目的**: データベース上のカード情報を、レスポンシブな一覧画面として表示します。
- **やること**:
  - `cards/views.py`に`CardListView`を作成し、全カードデータを取得するロジックを実装する。
  - `cards/urls.py`と`config/urls.py`で、一覧画面へのURLルーティングを設定する。
  - `cards/templates/cards/card_list.html`を作成し、DaisyUIの`card`コンポーネントと`grid`レイアウトを用いて、カード情報を一覧表示する。
  - フェーズ2で作成したレイアウト確認用の一時ビュー (`temp_base_view`) とURL (`/temp-base/`) を削除する。

#### フェーズ4: 検索・絞り込み機能の実装 (Filter): DONE

- **目的**: `django-filter`を導入し、キーワードや属性によるカードの絞り込み機能を追加します。
- **やること**:
  - `poetry add django-filter`コマンドでライブラリをインストールする。
  - `cards/filters.py`を新規作成し、検索条件を定義する`FilterSet`を実装する。
  - `CardListView`を改修し、GETリクエストに応じたフィルタリング処理を組み込む。
  - 一覧画面に検索フォームを設置し、`input`や`select`といった各部品をDaisyUIのコンポーネントでスタイリングする。

- **ゴール**: DaisyUIによるモダンなデザインのカード一覧画面が表示され、キーワードや属性でカードをフィルタリングできること。

## Step 5: 在庫操作と登録機能の実装 (Frontend - Write)

- **やること**: `htmx` を導入し、画面遷移なしでカードの登録・枚数増減・削除をモーダルや非同期処理で行う。
- **ゴール**: 管理画面に入らずとも、スマホ用画面だけでカードの登録・削除・枚数変更ができ、UXが大幅に向上すること。

### 計画詳細化 (`htmx`導入)

`htmx`の導入に伴い、Step5を以下の4フェーズに分けて段階的に実装します。

#### フェーズ1: `htmx`の環境構築: DONE

- **目的**: `htmx`をプロジェクトに導入し、非同期通信の準備を整えます。
- **やること**:
  - `poetry add django-htmx` を実行し、`django-htmx`をインストールします。
  - `config/settings.py` の `INSTALLED_APPS` に `'django_htmx'` を追加し、`MIDDLEWARE` に `django_htmx.middleware.HtmxMiddleware` を追加します。
  - `templates/base.html` に、`htmx.min.js` を読み込むための `<script>` タグを追加します。

#### フェーズ2: 新規登録機能の実装 (モーダル対応): DONE

- **目的**: モーダルウィンドウ内で完結するカード登録機能を作成します。
- **やること**:
  - `cards/views.py`に、フォームのHTML部品を返却するロジックと、POSTされたデータを保存して新しいカードのHTML部品を返却するロジックを持つビューを作成します。
  - `cards/urls.py`に、上記ビューに対応するURL（例: `/new/`）を定義します。
  - テンプレートの部品化:
    - `templates/cards/_card_form.html` (新規作成): カード登録フォームのみを持つHTML部品テンプレート。
    - `templates/cards/_card_item.html` (新規作成): カード1枚分の表示を担うHTML部品テンプレート。
    - `templates/cards/card_list.html` (修正): 「新規登録」ボタンに `htmx` 属性 (`hx-get`, `hx-target`) を追加し、モーダル内にフォームを呼び出すように設定。モーダル表示用のプレースホルダー `div` を配置。`htmx`が新しいカードを追加するためのターゲットとなる `div` をリストの先頭に配置。

#### フェーズ3: 枚数増減機能の実装 (非同期更新)

- **目的**: 画面をリロードすることなく、カードの枚数を増減させます。
- **やること**:
  - `cards/views.py`に、枚数を更新し、更新後のカード部品 (`_card_item.html`) をHTMLとして返すビューを作成します。
  - `cards/urls.py`に、枚数増減アクション用のURL（例: `/<int:pk>/increase/`）を定義します。
  - テンプレート修正: `templates/cards/_card_item.html` 内の「+」「-」ボタンに `htmx` 属性 (`hx-post`, `hx-target`, `hx-swap`) を追加します。`hx-target` にカード自身のIDを指定し、`hx-swap="outerHTML"` を設定することで、押されたカード全体が新しい内容に置き換わるようにします。

#### フェーズ4: 削除機能の実装 (モーダル対応)

- **目的**: 確認モーダルウィンドウを経て、非同期でカードを削除します。
- **やること**:
  - `cards/views.py`に、削除確認モーダルのHTML部品を返すロジックと、実際の削除処理を行うロジックを持つビューを作成します。削除が成功した場合は、中身が空のHTTPレスポンスを返します。
  - `cards/urls.py`に、上記ビューに対応するURL（例: `/<int:pk>/delete/`）を定義します。
  - テンプレートの部品化:
    - `templates/cards/_card_confirm_delete.html` (新規作成): 削除確認メッセージとボタンのみを持つHTML部品テンプレート。
    - `templates/cards/_card_item.html` (修正): 「削除」ボタンに `htmx` 属性を追加し、クリック時に確認モーダルを呼び出すように設定。削除成功時に `htmx` が要素を消せるよう、カード全体を囲む `div` にユニークなIDを付与します。

## Step 6: LAN内アクセス設定と実機検証 (Network)

- **やること**:
  - Django設定 (`ALLOWED_HOSTS`) の変更
  - PC側のファイアウォール設定確認
  - 家族のスマホからの接続テスト
- **ゴール**: 家族のスマホからアプリにアクセスし、操作できること。

## Step 7: 画像機能と仕上げ (Optional)

- **やること**:
  - モデルへの画像フィールド追加とアップロード処理の実装
  - 一覧画面への画像表示 (サムネイル)
  - Dockerボリューム設定による画像の永続化確認
- **ゴール**: カードの写真が登録でき、スマホ画面で画像付きのリストが見られること。

## Step 8: バッジのカスタマイズ機能の実装 (Display)

- **目的**: カード一覧画面に表示されるバッジ（タイプ、特徴など）の色と並び順を、管理画面から動的に設定できるようにする。
- **やること**:
  - `Type`, `EvolutionStage`, `SpecialFeature` モデルに、色クラスを保存する `color_class` フィールドと、表示順を制御する `display_order` フィールドを追加する。
  - データベースのマイグレーションを実行する。
  - 管理画面 (`admin.py`) を修正し、新しいフィールドを編集可能にする。
  - `CardListView` (`views.py`) を修正し、`display_order` に基づいてバッジがソートされるようにクエリを調整する (`Prefetch` の利用)。
  - テンプレート (`card_list.html`) を修正し、バッジの色が `color_class` フィールドの値に基づいて動的に適用されるように変更する。
- **ゴール**: 管理画面で「炎」タイプに「赤系のバッジ」を、「水」タイプに「青系のバッジ」を割り当てるなど、非エンジニアでも直感的に表示をカスタマイズできるようになること。

## Step 9: UI/UXの改善 (Polish)

- **目的**: アプリケーション全体のデザインを見直し、より洗練された使いやすいUI/UXを実現する。
- **やること**:
  - **フォーム部品の装飾**:
    - 新規登録フォームや検索フォーム内の各部品（チェックボックス、複数選択など）を、DaisyUI公式ドキュメントで紹介されているような、より装飾的で分かりやすいデザインにカスタマイズする。
    - 例えば、チェックボックスをスイッチのような見た目の「トグル（toggle）」コンポーネントに変更するなど、フィールドの種類に応じた最適なUIを検討・適用する。
    - この実現には、`cards/forms.py` や `cards/filters.py` でのウィジェット設定の高度化や、テンプレートファイル (`_card_form.html`など) でのHTML構造の調整が必要となる。
  - **デザインの調和**: 検索フォームのデザインを、カード表示コンポーネントと調和するよう、角丸や配色を調整する。
  - **全体テーマの洗練**: アプリケーション全体のカラーテーマやフォントを見直し、一貫性のあるデザインを適用する。
- **ゴール**: 機能性だけでなく、見た目にも満足度の高い、直感的に操作できるアプリケーションに仕上げること。

## Step 10: CSV入出力機能の改善 (Usability)

- **やること**:
  - エクスポートされるCSVのヘッダーを日本語化する（必須）
  - IDの代わりに名称（例: 「たね」「炎」）でインポートできるようにする（ファイル内で参照可能なものも含む）（必須）
  - CSVインポート機能に関するヘルプ画面を設ける（優先度: 中）
  - インポート用のCSVフォーマット例をダウンロードできる機能を設ける（優先度: 低）
- **ゴール**: 非エンジニアでもCSVファイルを直感的に編集・利用できるようになり、データメンテナンス性が向上すること。
