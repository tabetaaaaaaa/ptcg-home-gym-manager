{% load widget_tweaks %}

<div class="grid grid-cols-1 gap-2 mb-2">
    <div class="form-control">
        {{ filter.form.name|add_class:"input-md input-bordered border-secondary w-full text-sm"|attr:"placeholder:カード名" }}
    </div>
</div>

<div class="grid grid-cols-2 md:grid-cols-2 gap-3">
    {# Types Filter #}
    <div class="collapse collapse-plus bg-base-100 border-secondary border collapse-compact">
        <input type="checkbox" />
        <div class="collapse-title text-sm">
            {{ filter.form.types.label }}
        </div>
        <div class="collapse-content">
            <div class="grid grid-cols-[repeat(auto-fit,minmax(120px,1fr))] gap-x-4 gap-y-2 p-2">
            {% for choice in filter.form.types %}
                <label class="label cursor-pointer justify-start gap-3">
                    <input type="checkbox" class="checkbox checkbox-neutral" name="{{ choice.data.name }}" value="{{ choice.data.value }}" {% if choice.is_checked %}checked{% endif %} id="{{ choice.id_for_label }}" class="checkbox">
                    <span class="label-text text-sm">{{ choice.choice_label }}</span>
                </label>
            {% endfor %}
            </div>
        </div>
    </div>

    {# Evolution Stage Filter #}
    <div class="collapse collapse-plus bg-base-100 border-secondary border collapse-compact">
        <input type="checkbox" />
        <div class="collapse-title font-medium text-sm">
            {{ filter.form.evolution_stage.label }}
        </div>
        <div class="collapse-content">
            <div class="grid grid-cols-[repeat(auto-fit,minmax(140px,1fr))] gap-x-4 gap-y-2 p-2">
            {% for choice in filter.form.evolution_stage %}
                <label class="label cursor-pointer justify-start gap-3">
                    <input type="checkbox" name="{{ choice.data.name }}" value="{{ choice.data.value }}" {% if choice.is_checked %}checked{% endif %} id="{{ choice.id_for_label }}" class="checkbox">
                    <span class="label-text">{{ choice.choice_label }}</span>
                </label>
            {% endfor %}
            </div>
        </div>
    </div>

    {# Special Features Filter #}
    <div class="collapse collapse-plus bg-base-100 border-secondary border collapse-compact">
        <input type="checkbox" />
        <div class="collapse-title font-medium text-sm">
                {{ filter.form.special_features.label }}
            </div>
            <div class="collapse-content">
                <div class="grid grid-cols-[repeat(auto-fit,minmax(180px,1fr))] gap-x-4 gap-y-2 p-2">
                {% for choice in filter.form.special_features %}
                    <label class="label cursor-pointer justify-start gap-3">
                        <input type="checkbox" name="{{ choice.data.name }}" value="{{ choice.data.value }}" {% if choice.is_checked %}checked{% endif %} id="{{ choice.id_for_label }}" class="checkbox">
                        <span class="label-text">{{ choice.choice_label }}</span>
                    </label>
                {% endfor %}
                </div>
            </div>    </div>

    {# Move Types Filter #}
    <div class="collapse collapse-plus bg-base-100 border-secondary border collapse-compact">
        <input type="checkbox" />
        <div class="collapse-title font-medium text-sm">
            {{ filter.form.move_types.label }}
        </div>
        <div class="collapse-content">
            <div class="grid grid-cols-[repeat(auto-fit,minmax(120px,1fr))] gap-x-4 gap-y-2 p-2">
            {% for choice in filter.form.move_types %}
                <label class="label cursor-pointer justify-start gap-3">
                    <input type="checkbox" name="{{ choice.data.name }}" value="{{ choice.data.value }}" {% if choice.is_checked %}checked{% endif %} id="{{ choice.id_for_label }}" class="checkbox">
                    <span class="label-text">{{ choice.choice_label }}</span>
                </label>
            {% endfor %}
            </div>
        </div>
    </div>
</div>

<div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3">
    {# Weakness Filter #}
    <div class="collapse collapse-plus bg-base-100 border-secondary border collapse-compact">
        <input type="checkbox" />
        <div class="collapse-title font-medium text-sm">
            {{ filter.form.weakness.label }}
        </div>
        <div class="collapse-content">
            <div class="grid grid-cols-[repeat(auto-fit,minmax(120px,1fr))] gap-x-4 gap-y-2 p-2">
            {% for choice in filter.form.weakness %}
                <label class="label cursor-pointer justify-start gap-3">
                    <input type="checkbox" name="{{ choice.data.name }}" value="{{ choice.data.value }}" {% if choice.is_checked %}checked{% endif %} id="{{ choice.id_for_label }}" class="checkbox">
                    <span class="label-text">{{ choice.choice_label }}</span>
                </label>
            {% endfor %}
            </div>
        </div>
    </div>

    {# Resistance Filter #}
    <div class="collapse collapse-plus bg-base-100 border-secondary border collapse-compact">
        <input type="checkbox" />
        <div class="collapse-title font-medium text-sm">
            {{ filter.form.resistance.label }}
        </div>
        <div class="collapse-content">
            <div class="grid grid-cols-[repeat(auto-fit,minmax(120px,1fr))] gap-x-4 gap-y-2 p-2">
            {% for choice in filter.form.resistance %}
                <label class="label cursor-pointer justify-start gap-3">
                    <input type="checkbox" name="{{ choice.data.name }}" value="{{ choice.data.value }}" {% if choice.is_checked %}checked{% endif %} id="{{ choice.id_for_label }}" class="checkbox">
                    <span class="label-text">{{ choice.choice_label }}</span>
                </label>
            {% endfor %}
            </div>
        </div>
    </div>
    {# HP Filter (Slider) #}
    <div class="form-control" id="hp-slider-container">
        <label class="label pb-1">
            <span class="label-text text-xs font-bold">{{ filter.form.hp.label }}</span>
            <span class="text-xs font-mono"><span class="hp-min-display">0</span> ~ <span class="hp-max-display">340+</span></span>
        </label>
        <div class="relative h-8 w-full px-1">
            <!-- Track -->
            <div class="absolute top-1/2 left-0 right-0 h-1 bg-base-300 rounded -translate-y-1/2"></div>
            <!-- Range Bar -->
            <div class="hp-range-bar absolute top-1/2 h-1 bg-secondary rounded -translate-y-1/2 z-10" style="left: 0%; right: 0%;"></div>
            
            <!-- Interactable Inputs -->
            <input type="range" min="0" max="400" step="10" value="{{ filter.form.hp.subwidgets.0.data.value|default:0 }}"
                   class="hp-input-min absolute top-1/2 w-full -translate-y-1/2 z-20 appearance-none bg-transparent pointer-events-none [&::-webkit-slider-thumb]:pointer-events-auto [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-secondary [&::-webkit-slider-thumb]:border-2 [&::-webkit-slider-thumb]:border-secondary [&::-webkit-slider-thumb]:cursor-pointer [&::-moz-range-thumb]:pointer-events-auto [&::-moz-range-thumb]:w-4 [&::-moz-range-thumb]:h-4 [&::-moz-range-thumb]:rounded-full [&::-moz-range-thumb]:bg-secondary [&::-moz-range-thumb]:border-2 [&::-moz-range-thumb]:border-secondary [&::-moz-range-thumb]:cursor-pointer">
                   
            <input type="range" min="0" max="400" step="10" value="{{ filter.form.hp.subwidgets.1.data.value|default:400 }}"
                   class="hp-input-max absolute top-1/2 w-full -translate-y-1/2 z-20 appearance-none bg-transparent pointer-events-none [&::-webkit-slider-thumb]:pointer-events-auto [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-secondary [&::-webkit-slider-thumb]:border-2 [&::-webkit-slider-thumb]:border-secondary [&::-webkit-slider-thumb]:cursor-pointer [&::-moz-range-thumb]:pointer-events-auto [&::-moz-range-thumb]:w-4 [&::-moz-range-thumb]:h-4 [&::-moz-range-thumb]:rounded-full [&::-moz-range-thumb]:bg-secondary [&::-moz-range-thumb]:border-2 [&::-moz-range-thumb]:border-secondary [&::-moz-range-thumb]:cursor-pointer">
            
            <!-- Hidden Fields for Django Form -->
            <input type="hidden" name="{{ filter.form.hp.subwidgets.0.name }}" value="{{ filter.form.hp.subwidgets.0.data.value|default:0 }}" class="hp-hidden-min">
            <input type="hidden" name="{{ filter.form.hp.subwidgets.1.name }}" value="{{ filter.form.hp.subwidgets.1.data.value|default:400 }}" class="hp-hidden-max">
        </div>
    </div>

    {# Retreat Cost Filter (Slider) #}
    <div class="form-control" id="retreat-slider-container">
        <label class="label pb-1">
            <span class="label-text text-xs font-bold">{{ filter.form.retreat_cost.label }}</span>
            <span class="text-xs font-mono"><span class="retreat-min-display">0</span> ~ <span class="retreat-max-display">5</span></span>
        </label>
        <div class="relative h-8 w-full px-1">
            <div class="absolute top-1/2 left-0 right-0 h-1 bg-base-300 rounded -translate-y-1/2"></div>
            <div class="retreat-range-bar absolute top-1/2 h-1 bg-secondary rounded -translate-y-1/2 z-10" style="left: 0%; right: 0%;"></div>
            
            <input type="range" min="0" max="5" step="1" value="{{ filter.form.retreat_cost.subwidgets.0.data.value|default:0 }}"
                   class="retreat-input-min absolute top-1/2 w-full -translate-y-1/2 z-20 appearance-none bg-transparent pointer-events-none [&::-webkit-slider-thumb]:pointer-events-auto [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-secondary [&::-webkit-slider-thumb]:border-2 [&::-webkit-slider-thumb]:border-secondary [&::-webkit-slider-thumb]:cursor-pointer [&::-moz-range-thumb]:pointer-events-auto [&::-moz-range-thumb]:w-4 [&::-moz-range-thumb]:h-4 [&::-moz-range-thumb]:rounded-full [&::-moz-range-thumb]:bg-secondary [&::-moz-range-thumb]:border-2 [&::-moz-range-thumb]:border-secondary [&::-moz-range-thumb]:cursor-pointer">
                   
            <input type="range" min="0" max="5" step="1" value="{{ filter.form.retreat_cost.subwidgets.1.data.value|default:5 }}"
                   class="retreat-input-max absolute top-1/2 w-full -translate-y-1/2 z-20 appearance-none bg-transparent pointer-events-none [&::-webkit-slider-thumb]:pointer-events-auto [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-secondary [&::-webkit-slider-thumb]:border-2 [&::-webkit-slider-thumb]:border-secondary [&::-webkit-slider-thumb]:cursor-pointer [&::-moz-range-thumb]:pointer-events-auto [&::-moz-range-thumb]:w-4 [&::-moz-range-thumb]:h-4 [&::-moz-range-thumb]:rounded-full [&::-moz-range-thumb]:bg-secondary [&::-moz-range-thumb]:border-2 [&::-moz-range-thumb]:border-secondary [&::-moz-range-thumb]:cursor-pointer">
            
            <input type="hidden" name="{{ filter.form.retreat_cost.subwidgets.0.name }}" value="{{ filter.form.retreat_cost.subwidgets.0.data.value|default:0 }}" class="retreat-hidden-min">
            <input type="hidden" name="{{ filter.form.retreat_cost.subwidgets.1.name }}" value="{{ filter.form.retreat_cost.subwidgets.1.data.value|default:5 }}" class="retreat-hidden-max">
        </div>
    </div>

<script>
(function() {
    function initSlider(containerId, minLimit, maxLimit, prefix) {
        const container = document.getElementById(containerId);
        if(!container) return;

        const rangeMinInfo = container.querySelector(`.${prefix}-min-display`);
        const rangeMaxInfo = container.querySelector(`.${prefix}-max-display`);
        const inputMin = container.querySelector(`.${prefix}-input-min`);
        const inputMax = container.querySelector(`.${prefix}-input-max`);
        const hiddenMin = container.querySelector(`.${prefix}-hidden-min`);
        const hiddenMax = container.querySelector(`.${prefix}-hidden-max`);
        const rangeBar = container.querySelector(`.${prefix}-range-bar`);

        function updateSlider() {
            let vMin = parseInt(inputMin.value);
            let vMax = parseInt(inputMax.value);

            // Swap if crossed
            if (vMin > vMax) {
                const temp = vMin;
                vMin = vMax;
                vMax = temp;
                // We physically swap interactions for correct thumb control? 
                // Or just display swapped?
                // Standard UI pattern: min thumb stops at max thumb.
                // But for simple implementation, we can just allow crossing visually but display Correctly?
                // Or better: prevent crossing.
                // Let's prevent crossing for inputs:
                // Actually, just rendering the bar based on min/max of the two values is easiest UX.
                // The user moves "a thumb" and the one on the left is min.
            }

            rangeMinInfo.innerText = vMin;
            rangeMaxInfo.innerText = vMax;
            
            // Update hidden inputs
            hiddenMin.value = vMin;
            hiddenMax.value = vMax;

            // Visual bar
            const percentMin = ((vMin - minLimit) / (maxLimit - minLimit)) * 100;
            const percentMax = ((vMax - minLimit) / (maxLimit - minLimit)) * 100;
            
            rangeBar.style.left = percentMin + '%';
            rangeBar.style.width = (percentMax - percentMin) + '%';
        }

        // Prevent crossing logic for input interaction (optional but strictly better)
        inputMin.addEventListener('input', function() {
            let vMin = parseInt(inputMin.value);
            let vMax = parseInt(inputMax.value);
            if(vMin > vMax) {
                inputMin.value = vMax;
                vMin = vMax;
            }
            updateSlider();
        });

        inputMax.addEventListener('input', function() {
            let vMin = parseInt(inputMin.value);
            let vMax = parseInt(inputMax.value);
            if(vMax < vMin) {
                inputMax.value = vMin;
                vMax = vMin;
            }
            updateSlider();
        });
        
        // HTMX Trigger on change (drag end)
        function triggerChange() {
             hiddenMin.dispatchEvent(new Event('change', {bubbles: true}));
        }
        
        inputMin.addEventListener('change', triggerChange);
        inputMax.addEventListener('change', triggerChange);

        // Initial update
        updateSlider();
    }

    initSlider('hp-slider-container', 0, 400, 'hp');
    initSlider('retreat-slider-container', 0, 5, 'retreat');
})();
</script>
</div>

<div class="mt-4 flex justify-end items-center gap-2">
    <div class="form-control w-1/2 sm:w-1/4 md:w-1/4">
        <select name="ordering" class="select select-bordered border-secondary select-sm w-full">
            <option disabled {% if not filter.form.ordering.value %}selected{% endif %}>並び替え</option>
            {% for value, label in filter.form.ordering.field.choices %}
                <option value="{{ value }}" {% if filter.form.ordering.value|first == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
        </select>
    </div>
    <a href="{% url 'cards:pokemon_card_list' %}" class="btn btn-secondary btn-sm">リセット</a>
</div>
