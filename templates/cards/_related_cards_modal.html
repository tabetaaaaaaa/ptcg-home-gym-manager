{% load static %}

<dialog id="modal-related" class="modal modal-open">
    <div class="modal-box max-w-5xl">
        <button class="btn btn-sm btn-circle absolute right-2 top-2"
                onclick="this.closest('.modal').remove()">✕</button>

        <h3 class="font-bold text-lg mb-4">関連カード（進化系統）</h3>
        <p class="text-sm text-base-content/70 mb-4">起点: {{ origin_card.name }}</p>

        {# 進化段階ごとにカードを表示 #}
        {% for stage_data in stages_with_cards %}
            <div class="mb-6">
                <h4 class="font-semibold text-base mb-2 flex items-center gap-2">
                    <span class="badge badge-primary badge-sm">{{ stage_data.stage.name }}</span>
                </h4>

                {% if stage_data.cards %}
                    {# カードが存在する場合はテーブルで表示 #}
                    <div class="overflow-x-auto">
                        <table class="table table-sm table-zebra w-full">
                            <thead>
                                <tr>
                                    <th class="w-24 text-center">画像</th>
                                    <th class="w-44 text-center">カード名</th>
                                    <th class="w-32 text-center">タイプ</th>
                                    <th class="w-32 text-center">特別な分類</th>
                                    <th class="w-20 text-center">枚数</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for card in stage_data.cards %}
                                <tr>
                                    <td class="text-center">
                                        {% if card.image %}
                                            <img src="{{ card.image.url }}" alt="{{ card.name }}" class="w-12 h-16 object-cover rounded mx-auto">
                                        {% else %}
                                            <img src="{% static 'images/nonepic.png' %}" alt="{{ card.name }}" class="w-12 h-16 object-cover rounded mx-auto">
                                        {% endif %}
                                    </td>
                                    <td class="font-semibold">{{ card.name }}</td>
                                    <td class="text-center">
                                        <div class="flex flex-wrap gap-1 justify-center">
                                            {% for type in card.types.all %}
                                                <span class="badge badge-sm whitespace-nowrap" style="background-color: {{ type.bg_color }}; color: {{ type.text_color }};">{{ type.name }}</span>
                                            {% endfor %}
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <div class="flex flex-wrap gap-1 justify-center">
                                            {% for feature in card.special_features.all %}
                                                <span class="badge badge-neutral badge-dashed badge-sm whitespace-nowrap">{{ feature.name }}</span>
                                            {% endfor %}
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <span class="font-bold">{{ card.quantity }}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    {# カードが存在しない場合のメッセージ #}
                    <div class="alert alert-dash">
                        <span>ポケモンがいません</span>
                    </div>
                {% endif %}
            </div>
        {% endfor %}
    </div>
    <div class="modal-backdrop" onclick="this.parentElement.remove()"></div>
</dialog>

<script>
    (function() {
        const modal = document.getElementById('modal-related');

        // モーダルを表示
        modal.showModal();
    })();
</script>
