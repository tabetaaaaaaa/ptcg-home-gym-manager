<dialog id="modal-confirm-delete" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">削除確認</h3>
        <p class="py-4">本当に「{{ card.name }}」を削除しますか？<br>この操作は取り消せません。</p>
        <div class="modal-action">
            <button
                class="btn btn-error"
                hx-delete="{% url 'cards:card_delete' card.pk %}"
                hx-target="#card-{{ card.pk }}"
                hx-swap="outerHTML">
                削除する
            </button>
            <button type="button" class="btn" onclick="document.getElementById('modal-confirm-delete').close()">キャンセル</button>
        </div>
    </div>
</dialog>

<script>
    (function() {
        const modal = document.getElementById('modal-confirm-delete');
        
        // モーダルを表示
        if (modal) {
            modal.showModal();
        }

        // モーダルが閉じられたときに自身をDOMから削除する
        modal.addEventListener('close', () => {
            const dialogTarget = document.getElementById('dialog-target');
            if (dialogTarget) {
                dialogTarget.innerHTML = '';
            }
        });

        // htmxによるリクエストが完了する前に、成功ならモーダルを閉じる
        document.body.addEventListener('htmx:beforeSwap', function(evt) {
            // このモーダル内のフォームからのリクエストであるかを確認
            if(evt.detail.requestConfig.elt.closest('#modal-confirm-delete')) {
                // サーバーからのレスポンスヘッダーを確認
                const triggerHeader = evt.detail.xhr.getResponseHeader("HX-Trigger");
                
                if (triggerHeader) {
                    let shouldClose = false;
                    // 文字列完全一致チェック (旧仕様互換)
                    if (triggerHeader === 'closeModal') {
                        shouldClose = true;
                    } else {
                        // JSONパースチェック
                        try {
                            const triggers = JSON.parse(triggerHeader);
                            if (triggers.closeModal || Object.keys(triggers).includes('closeModal')) {
                                shouldClose = true;
                            }
                        } catch (e) {
                            // JSONパースエラーなら無視
                        }
                    }

                    if (shouldClose) {
                        modal.close();
                    }
                }
            }
        });
    })();
</script>
